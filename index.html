<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²€ë¶‰ì€ ë‹¬ì˜ ì„¬, ìì›”ë„ ë³´ë¬¼ íƒí—˜</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --poster-orange: #faa000;
      --poster-black: #050610;
      --text-main: #222222;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #f4f2eb;
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #app {
      position: relative;
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 390px;   /* iPhone 13 Pro í­ */
      height: 100vh;
      max-height: 844px;  /* iPhone 13 Pro ë†’ì´ */
      border-radius: 20px;
      border: 8px solid var(--poster-orange);
      overflow: hidden;
      background: #ffffff;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    }

    header {
      padding: 40px 20px 30px;
      padding-top: calc(env(safe-area-inset-top) + 50px);
      background: radial-gradient(circle at top, #f7c467 0, #f0a51b 40%, #e98d00 90%);
      border-bottom: 3px solid var(--poster-black);
      min-height: 220px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      color: #1b1205;
    }

    .header-top {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .logo {
      display: block;
      margin: 0 auto;
      max-width: 340px;
      height: auto;
    }

    .timer {
      font-size: 24px;
      border: 3px solid var(--poster-black);
      border-radius: 14px;
      background: rgba(0,0,0,0.08);
      font-variant-numeric: tabular-nums;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin: 10px auto 0;
      padding: 14px 28px;
      width: fit-content;
    }

    .sub-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      font-size: 14px;
      margin-top: 8px;
    }

    #map {
      width: 100%;
      flex: 1;
      border-top: 3px dashed var(--poster-black);
      background-color: #e5e3df;
      min-height: 300px;
    }

    .locate-btn {
      position: absolute;
      right: 18px;
      bottom: 24px;
      z-index: 5000;
      background: rgba(255,255,255,0.97);
      color: #333;
      border-radius: 999px;
      border: 2px solid var(--poster-orange);
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .locate-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
    }
    .modal-backdrop.show { display: flex; }

    /* ê²Œì´íŠ¸ ëª¨ë‹¬ì€ ìµœìƒë‹¨ì— */
    #gateBackdrop {
      z-index: 12000;
      background: rgba(0,0,0,0.88);
    }
    #gateTimer {
      margin-top: 8px;
      font-size: 22px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .modal {
      background: #201510;
      border: 3px solid var(--poster-orange);
      border-radius: 16px;
      padding: 20px;
      color: #fef5e3;
      max-width: 370px;
      width: 100%;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }

    .modal h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .modal p {
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 10px;
      white-space: pre-line;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.5);
      border-radius: 8px;
      color: #fef5e3;
      margin-bottom: 10px;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn {
      border: 2px solid var(--poster-orange);
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-primary {
      background: var(--poster-orange);
      color: var(--poster-black);
    }

    .btn-secondary {
      background: transparent;
      color: #fef5e3;
    }

    #qrReader {
      width: 260px;
      height: 260px;
      max-width: 80vw;
      max-height: 80vw;
      margin: 8px auto;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
    }

    #qrStatus {
      font-size: 13px;
      color: #faa000;
      text-align: center;
      min-height: 18px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="header-top">
      <img src="logo.png" alt="ìì›”ë„ ë³´ë¬¼ì„¬ ë¡œê³ " class="logo" />
    </div>
    <div class="timer" id="timer">ë‚¨ì€ ì‹œê°„ 03:00:00</div>
    <div class="sub-row">
      <div id="explorerInfo">íƒí—˜ê°€: - / íŒ€: -</div>
      <div id="progressInfo">ìˆ˜ì§‘í•œ ë³´ë¬¼: 0 / 9</div>
    </div>
  </header>

  <div id="map"></div>
  <button id="locateBtn" class="locate-btn">í˜„ìœ„ì¹˜</button>
</div>

<!-- ğŸ”’ ì˜¤í”ˆ ì „ ì ê¸ˆ ëª¨ë‹¬ -->
<div class="modal-backdrop" id="gateBackdrop">
  <div class="modal">
    <h2>ìì›”ë„ì˜ ë³´ë¬¼ì§€ë„ê°€ ë‚˜íƒ€ë‚˜ê¸°ê¹Œì§€ ë‚¨ì€ ì‹œê°„</h2>
    <p>ì´ ì›¹ì•±ì€ <strong>2025ë…„ 11ì›” 15ì¼ ì˜¤í›„ 2ì‹œ(í•œêµ­ì‹œê°„)</strong>ë¶€í„° ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ê·¸ ì „ê¹Œì§€ëŠ” ë³´ë¬¼ì§€ë„ì™€ QR ë¯¸ì…˜ì´ ì ê²¨ ìˆì–´ìš”.</p>
    <div id="gateTimer">--:--:--</div>
  </div>
</div>

<!-- ì¸íŠ¸ë¡œ ëª¨ë‹¬ -->
<div class="modal-backdrop show" id="introBackdrop">
  <div class="modal">
    <h2>ê²€ë¶‰ì€ ë‹¬ì˜ ì„¬, ìì›”ë„</h2>
    <p>ìì›”ë„ ì„¬ ìˆ˜í˜¸ìê°€ ìˆ¨ê²¨ë†“ì€ ë³´ë¬¼ë“¤ì„ ì°¾ì•„ë³´ì„¸ìš”.
11ì›” 15ì¼ ê·¸ë¯ë‚  ì˜¤í›„ 2ì‹œë¶€í„° ë‹¨ 3ì‹œê°„ë§Œ
ë³´ë¬¼ì´ ìˆ¨ê²¨ì§„ ìœ„ì¹˜ê°€ ì§€ë„ ìœ„ì— ë‚˜íƒ€ë‚  ê±°ì˜ˆìš”.
ë‹¹ì‹ ì—ê²Œ ì£¼ì–´ì§„ ì‹œê°„ì€ ë‹¨ 3ì‹œê°„.
ì§€ë„ë¥¼ ë”°ë¼ QRë³´ë¬¼ì„ ëª¨ë‘ ì°¾ì•„ë³´ì„¸ìš”.
í•´ë‹¹ ìœ„ì¹˜ ë°˜ê²½ 40mì—ì„œ ë³´ë¬¼ìƒìë¥¼ ëˆ„ë¥´ë©´ QRì„ ì°ê¸° ìœ„í•œ ì¹´ë©”ë¼ê°€ ì—´ë¦½ë‹ˆë‹¤.</p>

    <label>ë³´ë¬¼ íƒí—˜ê°€ ì´ë¦„</label>
    <input id="explorerName" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />

    <label>ë³´ë¬¼ì„ íƒí—˜í•˜ëŠ” íŒ€ëª… (ì„ íƒ)</label>
    <input id="teamName" type="text" placeholder="íŒ€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />

    <div class="modal-buttons">
      <button class="btn btn-primary" id="startButton">ë³´ë¬¼ì°¾ê¸° ì‹œì‘</button>
    </div>
  </div>
</div>

<!-- í€´ì¦ˆ/ì¼ë°˜ ëª¨ë‹¬ -->
<div class="modal-backdrop" id="genericBackdrop">
  <div class="modal" id="genericModal">
    <h2 id="genericTitle"></h2>
    <p id="genericBody"></p>
    <div id="quizWrapper" style="display:none;">
      <p id="quizQuestion"></p>
      <input id="quizInput" type="text" placeholder="ì •ë‹µ ì…ë ¥" />
      <p id="quizHint" style="font-size:12px;color:#faa000;"></p>
    </div>
    <div class="modal-buttons" id="genericButtons"></div>
  </div>
</div>

<!-- QR ìŠ¤ìº” ëª¨ë‹¬ -->
<div class="modal-backdrop" id="qrBackdrop">
  <div class="modal">
    <h2>ë³´ë¬¼ QR ìŠ¤ìº”</h2>
    <p>ì¹´ë©”ë¼ë¥¼ ì—´ì–´ QRì„ ì¸ì‹í•´ ì£¼ì„¸ìš”.</p>
    <div id="qrReader"></div>
    <p id="qrStatus"></p>
    <div class="modal-buttons">
      <button class="btn btn-secondary" id="qrCancelBtn">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = "jawol_google_final_v6";
  const urlParams = new URLSearchParams(location.search);
  const DEBUG_ALWAYS_NEW = urlParams.has("debug");
  const DEBUG_IGNORE_DISTANCE = urlParams.has("nodist");   // â˜… ê±°ë¦¬ë¬´ì‹œ ë””ë²„ê·¸
  const FORCE_OPEN_GATE = urlParams.has("forceopen");      // â˜… ê²Œì´íŠ¸ ê°•ì œ ì˜¤í”ˆìš© (?forceopen)

  // ğŸ”’ ë³´ë¬¼ì§€ë„ ì˜¤í”ˆ ì‹œê°„ (í•œêµ­ì‹œê°„ 2025-11-15 14:00)
  const GATE_UNLOCK_AT_KST = "2025-11-15T14:00:00+09:00";
  const GATE_UNLOCK_AT = new Date(GATE_UNLOCK_AT_KST);

  const TOTAL_TREASURES = 9;
  const DIST_THRESHOLD_METERS = 40;  // 40m ë°˜ê²½

  const JAWOL_CENTER = {
    lat: 37.25023908467981,
    lng: 126.31249485300387
  };

  // â˜… GPS í…ŒìŠ¤íŠ¸ ëª¨ë“œ (?testgps)
  const TEST_MODE = urlParams.has("testgps");
  const TEST_POS = JAWOL_CENTER;

  const CIRCLED_NUMBERS = ["â‘ ","â‘¡","â‘¢","â‘£","â‘¤","â‘¥","â‘¦","â‘§","â‘¨"];

  const TREASURES = [
    {
      id: 1,
      name: "ì¥ê³¨í•´ìˆ˜ìš•ì¥",
      position: { lat: 37.25023908467981, lng: 126.31249485300387 },
      qr: "J1",
      quiz: {
        q: "ìì›”ë„ëŠ” ì¸ì²œì‹œ 00êµ°ì— ì†í•´ ìˆë‹¤.",
        a: "ì˜¹ì§„"
      }
    },
    {
      id: 2,
      name: "ìì›”ë©´ì‚¬ë¬´ì†Œ",
      position: { lat: 37.25408162826835, lng: 126.30741295205134 },
      qr: "J2",
      quiz: {
        q: "í†µí•©ê¸°ì¤€ì  í‘œì§€ì„ì— ì íŒ ìœ„ë„+ê²½ë„ë¥¼ ìˆ«ìë§Œ ìˆœì„œëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš”.",
        a: "3715141261826"
      }
    },
    {
      id: 3,
      name: "êµ­ì‚¬ë´‰ ì •ì",
      position: { lat: 37.25645411250657, lng: 126.31563968837769 },
      qr: "J3",
      quiz: {
        q: "êµ­ì‚¬ë´‰ì˜ í•´ë°œê³ ë„mëŠ”?(ìˆ«ìë§Œì…ë ¥)",
        a: "166"
      }
    },
    {
      id: 4,
      name: "ëŒ ì œë‹¨",
      position: { lat: 37.25592079912797, lng: 126.31807648092273 },
      qr: "J4",
      quiz: {
        q: "ì„œìª½ì—ì„œ ë¶€ëŠ” ë°”ëŒì„ ìˆœìš°ë¦¬ë§ë¡œ 00ë°”ëŒì´ë¼ê³  í•œë‹¤",
        a: "í•˜ëŠ¬"
      }
    },
    {
      id: 5,
      name: "í•˜ëŠ¬ê»˜ í•´ìˆ˜ìš•ì¥",
      position: { lat: 37.256448013390504, lng: 126.3263596422856 },
      qr: "J5",
      story: "ì´ë²ˆì—” í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤. ì—¬ìœ ë¡­ê²Œ í’ê²½ì„ ê°ìƒí•˜ë©° ëª©ì„¬ê¹Œì§€ ì´ë™í•´ ë³´ì„¸ìš”. ëª©ì„¬ êµ¬ë¦„ë‹¤ë¦¬ë¥¼ ê±´ë„ˆë©´ ì•ˆëª©ì„¬ì— ìˆëŠ” ë²¤ì¹˜ë¥¼ ì˜ ì‚´í´ë³´ì„¸ìš”."
    },
    {
      id: 6,
      name: "ì•ˆëª©ì„¬",
      position: { lat: 37.260647184278525, lng: 126.32841054404861 },
      qr: "J6",
      story: "ì´ë²ˆì—ë„ ë³´ë¬¼ì„ ì–»ê¸° ìœ„í•œ í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤. ì—¬ìœ ë¡­ê²Œ í’ê²½ì„ ê°ìƒí•˜ë©° ë¹„ë°€ì˜ í•´ë³€ê°€ë¡œ ê°€ëŠ” ê¸¸ì„ ì°¾ì•„ë³´ì„¸ìš”. ëŒ€ë‚˜ë¬´ê°€ ìš°ê±°ì§„ ìˆ²ì„ ì§€ë‚˜ì•¼ ë¹„ë°€ì˜ í•´ë³€ì— ë‹¤ë‹¤ë¥¼ ìˆ˜ ìˆë‹µë‹ˆë‹¤."
    },
    {
      id: 7,
      name: "ë¹„ë°€ì˜ í•´ë³€",
      position: { lat: 37.24678208030957, lng: 126.32791653550872 },
      qr: "J7",
      story: "ì™€, ì´ í•´ë³€. ì •ë§ ë³´ë¬¼ê°™ì´ ì•„ë¦„ë‹µì§€ ì•Šë‚˜ìš”? ê³ ìƒí•œ ë³´ëŒì´ ìˆë„¤ìš”. ì´ë²ˆì—ë„ ë³´ë¬¼ì„ ì–»ê¸° ìœ„í•œ í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ëŒ€ë‚˜ë¬´ìˆ²ì„ ì§€ë‚˜ ìì›”ë„ì„¬ë§ˆì„ë°•ë¬¼ê´€ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”. ê°€ëŠ” ê¸¸ì˜ í’ê²½ì„ ì¦ê²¨ë³´ì„¸ìš”."
    },
    {
      id: 8,
      name: "ìì›”ë„ì„¬ë§ˆì„ë°•ë¬¼ê´€",
      position: { lat: 37.244726735607884, lng: 126.31828442848604 },
      qr: "J8",
      quiz: {
        q: "ì–´ë§ì´ ë°œë‹¬í•˜ê¸° ì´ì „ ê°¯ë²Œì— ëŒì„ ìŒ“ì•„ ì°ë¬¼ì— ë¬¼ê³ ê¸°ê°€ ë¹ ì ¸ë‚˜ê°€ì§€ ëª»í•˜ê²Œ ê°€ë‘ì–´ ì¡ëŠ” ì „í†µì ì¸ ì–´ì—… ë°©ì‹ì„ ë­ë¼ê³  í•˜ë‚˜ìš”?",
        a: "ëŒì‚´"
      }
    },
    {
      id: 9,
      name: "ì–´ë¶€ìƒ",
      position: { lat: 37.24475253367312, lng: 126.31689792536248 },
      qr: "J9",
      quiz: {
        q: "ìì›”ë„ íŠ¹ì‚°ë¬¼ 2ê°œ ì¤‘ ë°”ë‹¤ì—ì„œ ë‚˜ëŠ” ê²ƒì€? (ê°€ìš´ë° ì»´ë§ˆë¥¼ ê¼­ ë„£ì–´ì„œ ì¨ì£¼ì„¸ìš”)",
        a: "êµ´,ë°”ì§€ë½"
      }
    }
  ];

  const TRAIL_ROUTE = [
    // ìŠ¤íƒ€íŠ¸ ~ QR2 ê·¼ì²˜
    { lat: 37.2502283, lng: 126.3120516 }, // QR1 ì¥ê³¨í•´ìˆ˜ìš•ì¥
    { lat: 37.2500673, lng: 126.3096059 },
    { lat: 37.2498470, lng: 126.3086829 },
    { lat: 37.2503086, lng: 126.3079435 },
    { lat: 37.2509626, lng: 126.3078227 },
    { lat: 37.2516080, lng: 126.3077772 },
    { lat: 37.2522696, lng: 126.3073392 },
    { lat: 37.2529684, lng: 126.3071265 },
    { lat: 37.2536935, lng: 126.3074038 },
    { lat: 37.2540739, lng: 126.3074421 }, // QR2

    // QR2 â†’ êµ­ì‚¬ë´‰ / QR3
    { lat: 37.2545585, lng: 126.3084981 },
    { lat: 37.2549280, lng: 126.3091223 },
    { lat: 37.2555673, lng: 126.3096309 },
    { lat: 37.2561439, lng: 126.3094151 },
    { lat: 37.2568715, lng: 126.3101991 },
    { lat: 37.2573549, lng: 126.3124398 },
    { lat: 37.2568497, lng: 126.3136066 },
    { lat: 37.2565762, lng: 126.3140775 },
    { lat: 37.2563700, lng: 126.3149958 },
    { lat: 37.2564413, lng: 126.3154901 },
    { lat: 37.2564139, lng: 126.3156307 }, // QR3

    // QR3 â†’ QR4 (ëŒ ì œë‹¨)
    { lat: 37.2563224, lng: 126.3164511 },
    { lat: 37.2563659, lng: 126.3167647 },
    { lat: 37.2563204, lng: 126.3171958 },
    { lat: 37.2561776, lng: 126.3174589 },
    { lat: 37.2560615, lng: 126.3173723 }, // QR4

    // QR4 â†’ QR5 (í•˜ëŠ¬ê»˜ í•´ìˆ˜ìš•ì¥)
    { lat: 37.2559676, lng: 126.3181131 },
    { lat: 37.2555492, lng: 126.3187088 },
    { lat: 37.2550796, lng: 126.3192212 },
    { lat: 37.2546390, lng: 126.3203576 },
    { lat: 37.2542335, lng: 126.3218190 },
    { lat: 37.2547415, lng: 126.3226020 },
    { lat: 37.2553109, lng: 126.3234819 },
    { lat: 37.2552206, lng: 126.3246652 },
    { lat: 37.2548988, lng: 126.3263415 },
    { lat: 37.2551387, lng: 126.3269266 },
    { lat: 37.2560837, lng: 126.3265056 },
    { lat: 37.2565194, lng: 126.3263909 },
    { lat: 37.2565233, lng: 126.3264214 }, // QR5

    // QR5 â†’ QR6 (ì•ˆëª©ì„¬)
    { lat: 37.2566024, lng: 126.3270415 },
    { lat: 37.2565606, lng: 126.3274269 },
    { lat: 37.2567911, lng: 126.3279195 },
    { lat: 37.2571520, lng: 126.3281934 },
    { lat: 37.2572383, lng: 126.3285959 },
    { lat: 37.2568927, lng: 126.3292130 },
    { lat: 37.2576266, lng: 126.3291187 },
    { lat: 37.2583605, lng: 126.3290244 },
    { lat: 37.2588602, lng: 126.3289725 },
    { lat: 37.2597254, lng: 126.3289968 },
    { lat: 37.2601669, lng: 126.3286301 },
    { lat: 37.2604325, lng: 126.3285574 }, // QR6

    // QR6 â†’ QR7 (ë¹„ë°€ì˜ í•´ë³€ ê·¼ì²˜ë¡œ)
    { lat: 37.2599428, lng: 126.3288346 },
    { lat: 37.2594019, lng: 126.3291297 },
    { lat: 37.2589003, lng: 126.3289502 },
    { lat: 37.2583474, lng: 126.3290205 },
    { lat: 37.2576233, lng: 126.3291168 },
    { lat: 37.2566019, lng: 126.3290995 },
    { lat: 37.2560785, lng: 126.3285918 },
    { lat: 37.2554465, lng: 126.3279382 },
    { lat: 37.2541766, lng: 126.3276281 },
    { lat: 37.2536099, lng: 126.3272678 },
    { lat: 37.2527741, lng: 126.3264525 },
    { lat: 37.2521953, lng: 126.3262881 },
    { lat: 37.2513810, lng: 126.3255095 },
    { lat: 37.2509989, lng: 126.3255929 },
    { lat: 37.2508446, lng: 126.3253500 },
    { lat: 37.2506341, lng: 126.3255773 },
    { lat: 37.2505953, lng: 126.3258819 },
    { lat: 37.2508590, lng: 126.3262966 },
    { lat: 37.2501871, lng: 126.3265759 },

    { lat: 37.2494546, lng: 126.3262023 },
    { lat: 37.2489982, lng: 126.3266758 },
    { lat: 37.2482480, lng: 126.3271361 },
    { lat: 37.2475598, lng: 126.3271582 },
    { lat: 37.2472223, lng: 126.3275941 },
    { lat: 37.2471884, lng: 126.3280812 },
    { lat: 37.2468665, lng: 126.3280569 }, // QR7

    // QR7 â†’ QR8 (ì„¬ë§ˆì„ë°•ë¬¼ê´€)
    { lat: 37.2472141, lng: 126.3276666 },
    { lat: 37.2477587, lng: 126.3270216 },
    { lat: 37.2481917, lng: 126.3271157 },
    { lat: 37.2479826, lng: 126.3268050 },
    { lat: 37.2476538, lng: 126.3267522 },
    { lat: 37.2476142, lng: 126.3265652 },
    { lat: 37.2479000, lng: 126.3262564 },
    { lat: 37.2481858, lng: 126.3259476 },
    { lat: 37.2484427, lng: 126.3256038 },
    { lat: 37.2484256, lng: 126.3251278 },
    { lat: 37.2479047, lng: 126.3245521 },
    { lat: 37.2476052, lng: 126.3240858 },
    { lat: 37.2471734, lng: 126.3220327 },
    { lat: 37.2464983, lng: 126.3218615 },
    { lat: 37.2467776, lng: 126.3211796 },
    { lat: 37.2466694, lng: 126.3204633 },
    { lat: 37.2463112, lng: 126.3198630 },
    { lat: 37.2456928, lng: 126.3198889 },
    { lat: 37.2451246, lng: 126.3191900 },
    { lat: 37.2447718, lng: 126.3190398 },
    { lat: 37.2446612, lng: 126.3182139 },
    { lat: 37.2448629, lng: 126.3182970 }, // QR8

    // QR8 â†’ QR9(ì–´ë¶€ìƒ) â†’ ë‹¤ì‹œ ìŠ¤íƒ€íŠ¸ ê·¼ì²˜
    { lat: 37.2447165, lng: 126.3186268 },
    { lat: 37.2447821, lng: 126.3174770 },
    { lat: 37.2447685, lng: 126.3170192 }, // QR9
    { lat: 37.2454990, lng: 126.3170880 },
    { lat: 37.246246,  lng: 126.31725 },
    { lat: 37.2472654, lng: 126.3166244 },
    { lat: 37.2482931, lng: 126.3168277 },
    { lat: 37.2492385, lng: 126.3163765 },
    { lat: 37.2498462, lng: 126.3149985 },
    { lat: 37.2501769, lng: 126.3136201 },
    { lat: 37.2499519, lng: 126.3120945 },
    { lat: 37.2502283, lng: 126.3120516 }  // ìŠ¤íƒ€íŠ¸ë¡œ íšŒê·€
  ];

  function checkAnswerFlexible(correct, input) {
    const clean = str => str.replace(/\s+/g,"").split(/[,]/).filter(Boolean);
    const correctList = clean(correct);
    const inputList = clean(input);
    if (correctList.length === 0 || inputList.length === 0) return false;
    const everyInInput = correctList.every(ans => inputList.includes(ans));
    const everyInCorrect = inputList.every(ans => correctList.includes(ans));
    return everyInInput || everyInCorrect;
  }

  // ğŸ”’ í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ í˜„ì¬ ì‹œê°
  function nowKST() {
    return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
  }

  // ğŸ”’ ê²Œì´íŠ¸(ì ê¸ˆ) ì œì–´
  const gateBackdrop = document.getElementById("gateBackdrop");
  const gateTimerEl = document.getElementById("gateTimer");
  let gateInterval = null;

  function setupGate() {
    if (!gateBackdrop) return;

    if (FORCE_OPEN_GATE) {
      gateBackdrop.classList.remove("show");
      return;
    }

    const now = nowKST();
    if (now >= GATE_UNLOCK_AT) {
      gateBackdrop.classList.remove("show");
      return;
    }

    // ì˜¤í”ˆ ì „ì´ë¼ë©´ ê²Œì´íŠ¸ ëª¨ë‹¬ì„ ë„ìš°ê³  ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
    gateBackdrop.classList.add("show");
    startGateCountdown();
  }

  function startGateCountdown() {
    if (!gateTimerEl) return;

    function tick() {
      const now = nowKST();
      let diff = GATE_UNLOCK_AT - now;
      if (diff <= 0) {
        clearInterval(gateInterval);
        gateBackdrop.classList.remove("show");
        return;
      }
      const totalSec = Math.floor(diff / 1000);
      const h = String(Math.floor(totalSec / 3600)).padStart(2,"0");
      const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2,"0");
      const s = String(totalSec % 60).padStart(2,"0");
      gateTimerEl.textContent = `${h}:${m}:${s}`;
    }

    tick();
    gateInterval = setInterval(tick, 1000);
  }

  let map, userMarker, routePolyline;
  let explorerName = "", teamName = "";
  let gameStarted = false;
  let mapsLoaded = false, shouldInitMap = false;

  let clearedIds = new Set();
  let markerById = {};
  let CLOSED_ICON, OPEN_ICON;

  let userPos = null;
  let lastHeading = 0;

  let gameStartTime = null;
  let endTime = null;
  let timerInterval = null;
  const timerEl = document.getElementById("timer");

  function initMap() {
    const el = document.getElementById("map");
    if (!el) return;

    map = new google.maps.Map(el, {
      center: JAWOL_CENTER,
      zoom: 14,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });

    CLOSED_ICON = {
      url: "closed-chest.png",
      scaledSize: new google.maps.Size(35, 26),
      labelOrigin: new google.maps.Point(18, 0)
    };
    OPEN_ICON = {
      url: "open-chest.png",
      scaledSize: new google.maps.Size(35, 26),
      labelOrigin: new google.maps.Point(18, 0)
    };

    routePolyline = new google.maps.Polyline({
      path: TRAIL_ROUTE,
      geodesic: true,
      strokeColor: "#ff8c00",
      strokeOpacity: 0.9,
      strokeWeight: 4,
      map
    });

    TREASURES.forEach((t, i) => {
      const icon = clearedIds.has(t.id) ? OPEN_ICON : CLOSED_ICON;
      const labelChar = CIRCLED_NUMBERS[i] || String(i+1);

      const marker = new google.maps.Marker({
        position: t.position,
        map,
        icon,
        label: {
          text: labelChar,
          color: "#ffffff",
          fontWeight: "bold",
          fontSize: "18px"
        },
        zIndex: 10
      });

      markerById[t.id] = marker;
      marker.addListener("click", () => onTreasureClick(t));
    });

    if (navigator.geolocation && !TEST_MODE) {
      navigator.geolocation.watchPosition(
        position => {
          const { latitude, longitude, heading } = position.coords;
          userPos = { lat: latitude, lng: longitude };

          if (heading !== null && !Number.isNaN(heading)) {
            lastHeading = heading;
          }

          const icon = {
            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
            scale: 6,
            fillColor: "#007aff",
            fillOpacity: 1,
            strokeColor: "#ffffff",
            strokeWeight: 2,
            rotation: lastHeading
          };

          if (!userMarker) {
            userMarker = new google.maps.Marker({
              position: userPos,
              map,
              icon,
              title: "í˜„ì¬ ìœ„ì¹˜"
            });
            map.setCenter(userPos);
            map.setZoom(17);
          } else {
            userMarker.setPosition(userPos);
            userMarker.setIcon(icon);
          }
        },
        error => {
          console.error("GPS ì—ëŸ¬", error);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 15000
        }
      );
    } else if (TEST_MODE) {
      userPos = TEST_POS;
      const icon = {
        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
        scale: 6,
        fillColor: "#007aff",
        fillOpacity: 1,
        strokeColor: "#ffffff",
        strokeWeight: 2,
        rotation: 0
      };
      userMarker = new google.maps.Marker({
        position: TEST_POS,
        map,
        icon,
        title: "í…ŒìŠ¤íŠ¸ ìœ„ì¹˜"
      });
      map.setCenter(TEST_POS);
      map.setZoom(17);
    }

    setTimeout(() => {
      google.maps.event.trigger(map, "resize");
      map.setCenter(JAWOL_CENTER);
    }, 800);
  }

  function onMapsReady() {
    mapsLoaded = true;
    if (shouldInitMap && gameStarted) {
      setTimeout(() => {
        initMap();
        setTimeout(() => {
          if (map) {
            google.maps.event.trigger(map, "resize");
            map.setCenter(JAWOL_CENTER);
          }
        }, 1000);
      }, 300);
    }
  }
  window.onMapsReady = onMapsReady;

  function ensureMapInit() {
    if (mapsLoaded) {
      if (!map) {
        initMap();
      } else {
        google.maps.event.trigger(map, "resize");
      }
    } else {
      shouldInitMap = true;
    }
  }

  function startTimer(existingStartTime) {
    const THREE_HOURS = 3 * 60 * 60 * 1000;

    if (existingStartTime) gameStartTime = existingStartTime;
    else gameStartTime = Date.now();

    endTime = gameStartTime + THREE_HOURS;
    if (timerInterval) clearInterval(timerInterval);

    function tick() {
      const now = Date.now();
      const diff = endTime - now;

      if (diff <= 0) {
        clearInterval(timerInterval);
        timerEl.textContent = "ë‚¨ì€ ì‹œê°„ 00:00:00";
        showModal("ì‹œê°„ ì¢…ë£Œ", "3ì‹œê°„ì´ ëª¨ë‘ ì§€ë‚¬ìŠµë‹ˆë‹¤.\nì¶œë°œì§€ë¡œ ëŒì•„ê°€ ì£¼ì„¸ìš”.");
        return;
      }

      const totalSec = Math.floor(diff / 1000);
      const h = String(Math.floor(totalSec / 3600)).padStart(2,"0");
      const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2,"0");
      const s = String(totalSec % 60).padStart(2,"0");
      timerEl.textContent = `ë‚¨ì€ ì‹œê°„ ${h}:${m}:${s}`;
    }

    tick();
    timerInterval = setInterval(tick, 1000);
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      explorerName,
      teamName,
      gameStarted: true,
      startTime: gameStartTime,
      clearedIds: Array.from(clearedIds)
    }));
  }

  function loadState() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY));
    } catch {
      return null;
    }
  }

  function restoreIfExists() {
    if (DEBUG_ALWAYS_NEW) {
      localStorage.removeItem(STORAGE_KEY);
      return;
    }

    const s = loadState();
    if (!s || !s.gameStarted) return;

    const THREE_HOURS = 3 * 60 * 60 * 1000;
    const now = Date.now();
    if (!s.startTime || now >= s.startTime + THREE_HOURS) {
      localStorage.removeItem(STORAGE_KEY);
      return;
    }

    explorerName = s.explorerName;
    teamName = s.teamName;
    clearedIds = new Set(s.clearedIds || []);
    gameStarted = true;
    gameStartTime = s.startTime;

    document.getElementById("introBackdrop").classList.remove("show");
    updateUI();
    startTimer(s.startTime);
    ensureMapInit();
  }

  function updateUI() {
    document.getElementById("explorerInfo").textContent =
      `íƒí—˜ê°€: ${explorerName} / íŒ€: ${teamName || "-"}`;
    document.getElementById("progressInfo").textContent =
      `ìˆ˜ì§‘í•œ ë³´ë¬¼: ${clearedIds.size} / ${TOTAL_TREASURES}`;
  }

  function refreshMarkerIcons() {
    TREASURES.forEach((t) => {
      const marker = markerById[t.id];
      if (!marker || !CLOSED_ICON || !OPEN_ICON) return;
      const icon = clearedIds.has(t.id) ? OPEN_ICON : CLOSED_ICON;
      marker.setIcon(icon);
    });
  }

  function distanceInMeters(posA, posBObj) {
    const R = 6371000;
    const lat1 = posA.lat();
    const lng1 = posA.lng();
    const lat2 = posBObj.lat;
    const lng2 = posBObj.lng;

    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;

    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLng/2) * Math.sin(dLng/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function onTreasureClick(t) {
    // ë””ë²„ê·¸ê°€ ì•„ë‹ˆë©´ GPS ì—†ì„ ë•Œ ë§‰ê¸°
    if (!userMarker && !DEBUG_IGNORE_DISTANCE) {
      alert("GPSë¥¼ í™•ì¸ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
      return;
    }

    if (!DEBUG_IGNORE_DISTANCE) {
      const d = distanceInMeters(
        userMarker.getPosition(),
        t.position
      );
      if (d > DIST_THRESHOLD_METERS) {
        alert(`ë³´ë¬¼ìƒìê¹Œì§€ ì•½ ${Math.round(d)}m ë‚¨ì•˜ìŠµë‹ˆë‹¤.\n${DIST_THRESHOLD_METERS}m ì´ë‚´ë¡œ ì ‘ê·¼í•´ ì£¼ì„¸ìš”.`);
        return;
      }
    } else {
      // ë””ë²„ê·¸ ëª¨ë“œì—ì„œëŠ” ê±°ë¦¬ë§Œ ì½˜ì†”ì— ì°¸ê³ ìš© ì¶œë ¥
      if (userMarker) {
        const d = distanceInMeters(userMarker.getPosition(), t.position);
        console.log(`DEBUG_IGNORE_DISTANCE ON - ì‹¤ì œ ê±°ë¦¬ ì•½ ${Math.round(d)}m`);
      } else {
        console.log("DEBUG_IGNORE_DISTANCE ON - userMarker ì—†ìŒ, ê±°ë¦¬ ê³„ì‚° ìŠ¤í‚µ");
      }
    }

    openQRModal(t);
  }

  document.getElementById("locateBtn").addEventListener("click", () => {
    if (map && userMarker) {
      map.panTo(userMarker.getPosition());
      map.setZoom(17);
    } else if (map && navigator.geolocation && !TEST_MODE) {
      navigator.geolocation.getCurrentPosition(p => {
        const pos = { lat: p.coords.latitude, lng: p.coords.longitude };
        map.panTo(pos);
        map.setZoom(17);
      });
    } else if (map && TEST_MODE) {
      map.panTo(TEST_POS);
      map.setZoom(17);
    }
  });

  let html5QrCode = null;
  let qrScanning = false;
  const qrBackdrop = document.getElementById("qrBackdrop");
  const qrStatus = document.getElementById("qrStatus");
  const qrCancelBtn = document.getElementById("qrCancelBtn");

  function openQRModal(t) {
    qrStatus.textContent = "";
    qrBackdrop.classList.add("show");

    if (!window.Html5Qrcode) {
      qrStatus.textContent = "QR ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
      return;
    }
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("qrReader");
    }

    qrScanning = true;
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 220, height: 220 } },
      txt => {
        if (!qrScanning) return;
        if (txt === t.qr) {
          qrScanning = false;
          html5QrCode.stop().then(() => html5QrCode.clear()).catch(() => {});
          qrBackdrop.classList.remove("show");
          handleQR(t);
        } else {
          qrStatus.textContent = "ë‹¤ë¥¸ QRì…ë‹ˆë‹¤. ë³´ë¬¼ QRì„ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.";
        }
      },
      err => {}
    ).catch(err => {
      qrStatus.textContent = "ì¹´ë©”ë¼ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¶Œí•œê³¼ HTTPSë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
    });
  }

  qrCancelBtn.onclick = () => {
    if (html5QrCode && qrScanning) {
      qrScanning = false;
      html5QrCode.stop().then(() => html5QrCode.clear()).catch(() => {});
    }
    qrBackdrop.classList.remove("show");
  };

  function markCleared(t) {
    if (!clearedIds.has(t.id)) {
      clearedIds.add(t.id);
      refreshMarkerIcons();
      updateUI();
      saveState();
    }
  }

  function handleQR(t) {
    if (t.story) {
      markCleared(t);
      showModal(t.name, t.story);
      return;
    }
    if (t.quiz) {
      showQuiz(t);
      return;
    }
    markCleared(t);
    showModal(t.name, "ë³´ë¬¼ì„ íšë“í–ˆìŠµë‹ˆë‹¤!");
  }

  function showQuiz(t) {
    const modal = document.getElementById("genericBackdrop");
    const qW = document.getElementById("quizWrapper");
    const qQ = document.getElementById("quizQuestion");
    const qI = document.getElementById("quizInput");
    const qH = document.getElementById("quizHint");
    const gT = document.getElementById("genericTitle");
    const gB = document.getElementById("genericBody");
    const gBtns = document.getElementById("genericButtons");

    gT.textContent = t.name;
    gB.textContent = "";
    qW.style.display = "block";
    qQ.textContent = t.quiz.q;
    qI.value = "";
    qH.textContent = "";
    gBtns.innerHTML =
      "<button class='btn btn-secondary' id='cancelQ'>ì·¨ì†Œ</button>" +
      "<button class='btn btn-primary' id='submitQ'>ì •ë‹µì œì¶œ</button>";

    modal.classList.add("show");

    document.getElementById("cancelQ").onclick = () => {
      modal.classList.remove("show");
    };

    document.getElementById("submitQ").onclick = () => {
      const ans = qI.value.trim();
      if (!ans) {
        qH.textContent = "ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”.";
        return;
      }

      if (checkAnswerFlexible(t.quiz.a, ans)) {
        modal.classList.remove("show");
        markCleared(t);

        if (t.id === 1) {
          showModalHTML(
            t.name,
            `í›Œë¥­í•˜êµ°ìš”. ë‹¤ìŒ ë³´ë¬¼ì€ ìì›”ë©´ì‚¬ë¬´ì†Œì— ìˆìŠµë‹ˆë‹¤.<br>
            ë©´ì‚¬ë¬´ì†Œì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì–‘ì„ ì°¾ì•„ ê°€ì„¸ìš”.<br><br>
            <img src="pattern-hint.png"
                 alt="íŒ¨í„´ íŒíŠ¸"
                 style="width:100%;max-width:260px;display:block;margin:8px auto;border-radius:8px;" />`
          );
        } else if (t.id === 2) {
          showModalHTML(
            t.name,
            `ì˜ ì°¾ìœ¼ì…¨ë„¤ìš”. ëª¨ë“  ë³´ë¬¼ë“¤ì´ ì „ë¶€ ìœ„ë„ì™€ ê²½ë„ë¡œ í‘œì‹œê°€ ë¼ ìˆìœ¼ë©´ ë³´ë¬¼ì„ ì°¾ëŠ” ê²ƒë„ ì‰¬ìš´ë°â€¦<br>
            ì˜›ë‚  ì‚¬ëŒë“¤ì€ ìœ„ë„ì™€ ê²½ë„, GPS ê°™ì€ ê²Œ ì—†ì—ˆì„í…ë° ì–´ë–»ê²Œ ë³´ë¬¼ì„ ìˆ¨ê¸°ê³  ê·¸ ìœ„ì¹˜ë¥¼ ê¸°ì–µí–ˆì„ê¹Œâ€¦<br>
            ì•„, ì œì¼ ë†’ì€ ê³³ì„ ì˜¬ë¼ì„œ ì§€í˜•ì„ ë³´ë©´ì„œ ìˆ¨ê²¼ê² êµ°.<br><br>
            ìì›”ë„ì—ì„œ ì œì¼ ë†’ì€ ê³³ìœ¼ë¡œ ì˜¬ë¼ê°€ ë´…ì‹œë‹¤.<br>
            ì§€ë„ë¥¼ ë”°ë¼ êµ­ì‚¬ë´‰ìœ¼ë¡œ ê°€ë³´ì„¸ìš”.`
          );
        } else if (t.id === 3) {
          showModalHTML(
            t.name,
            `ìì›”ë„ì—ì„œ ì œì¼ ë†’ì€ ê³³ì„ ì˜ ì°¾ìœ¼ì…¨êµ°ìš”.<br>
            ì–µìš¸í•œ ëˆ„ëª…ì„ ì“°ê³  ìœ ë°° ì™”ë˜ ì‚¬ëŒë“¤ì„ ìƒê°í•´ë³´ë‹ˆ ìì›”ë„ê°€ ë‹¤ì‹œ ë³´ì´ëŠ”êµ°ìš”.<br><br>
            ë‹¤ìŒ ë³´ë¬¼ì€ ëŒ ì œë‹¨ì— ìˆìŠµë‹ˆë‹¤.<br>
            ì¡°ì„ ì‹œëŒ€ì—ëŠ” ë´‰í™”ëŒ€ë¡œë„ ì‚¬ìš©ëë‹¤ê³  í•˜ë”êµ°ìš”.`
          );
        } else if (t.id === 4) {
          showModalHTML(
            t.name,
            "ì •ë‹µì…ë‹ˆë‹¤. ë‹¤ìŒ ë³´ë¬¼ì˜ ìœ„ì¹˜ëŠ” í•˜ëŠ¬ê»˜ í•´ìˆ˜ìš•ì¥ì…ë‹ˆë‹¤. ì£¼ì°¨ê³µê°„ ì£¼ë³€ì„ ì˜ ì°¾ì•„ë³´ì„¸ìš”."
          );
        } else if (t.id === 8) {
          showModalHTML(
            t.name,
            `ì˜¤ëŠ˜ ì €ë…ì— ê°¯ë²Œì—ì„œ ì „í†µì ì¸ ë°©ì‹ìœ¼ë¡œ ë¬¼ê³ ê¸°ë¥¼ ì¡ì•„ë³¼ ìˆ˜ ìˆê² ë‹¤ëŠ” ìƒê°ë„ ë“­ë‹ˆë‹¤.<br>
            ì¡°ìˆ˜ê°„ë§Œì´ ì»¤ì„œ ì–´ë¶€ë“¤ì´ ì°ë¬¼ ë•ŒëŠ” ë°°ë¥¼ í•´ì•ˆìœ¼ë¡œ ëŒ€ê¸°ë„ í˜ë“¤ì—ˆì„ ê²ƒ ê°™ì•„ìš”.<br><br>
            ì•ˆ ê·¸ë˜ë„ ì•„ë‚´ë¥¼ ë‘ê³  ë°”ë‹¤ë¥¼ ë‚˜ê°”ë‹¤ê°€ ëŒì•„ì˜¤ì§€ ëª»í•œ ì–´ë¶€ê°€ ìˆë‹¤ëŠ”ë°<br>
            ê·¸ ì–´ë¶€ë¥¼ ì°¾ìœ¼ë©´ ë§ˆì§€ë§‰ QRë³´ë¬¼ì„ ì°¾ì„ ìˆ˜ ìˆì„ê±°ì—ìš”.`
          );
        } else if (t.id === 9) {
          showModalHTML(
            t.name,
            `ìì›”ë„ì— í©ì–´ì ¸ ìˆëŠ” QRë³´ë¬¼ì„ ëª¨ë‘ ìˆ˜ì§‘í•˜ì…¨êµ°ìš”. <br> 
            ì ê·¸ëŸ¼ ì´ì œ ì„œë‘˜ëŸ¬ì„œ ìš°ë¦¬ê°€ ì¶œë°œí–ˆë˜ ê³³ìœ¼ë¡œ ëŒì•„ê°€ ë³´ì‹œì£ . <br>
            ì„¬ìˆ˜í˜¸ìê°€ ì¤€ë¹„í•œ ìì›”ë„ì˜ ì§„ì§œ ë³´ë¬¼, ì‹ ë¹„í•œ ë¶‰ì€ ë‹¬ì´ ì„ ë¬¼ì²˜ëŸ¼ ì—¬ëŸ¬ë¶„ì„ ë§ì´í•  í…Œë‹ˆê¹ìš”.`
          );
        } else {
          showModal(t.name, "ì •ë‹µì…ë‹ˆë‹¤! ë‹¤ìŒ ì¥ì†Œë¡œ ì´ë™í•˜ì„¸ìš”.");
        }

      } else {
        qH.textContent = "í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
      }
    };
  }

  function showModal(title, body) {
    const m = document.getElementById("genericBackdrop");
    const t = document.getElementById("genericTitle");
    const b = document.getElementById("genericBody");
    const btn = document.getElementById("genericButtons");
    document.getElementById("quizWrapper").style.display = "none";
    t.textContent = title;
    b.textContent = body;
    btn.innerHTML = "<button class='btn btn-primary' id='okBtn'>í™•ì¸</button>";
    document.getElementById("okBtn").onclick = () => m.classList.remove("show");
    m.classList.add("show");
  }

  function showModalHTML(title, html) {
    const m = document.getElementById("genericBackdrop");
    const t = document.getElementById("genericTitle");
    const b = document.getElementById("genericBody");
    const btn = document.getElementById("genericButtons");

    document.getElementById("quizWrapper").style.display = "none";

    t.textContent = title;
    b.innerHTML = html;

    btn.innerHTML = "<button class='btn btn-primary' id='okBtn'>OK</button>";
    document.getElementById("okBtn").onclick = () => {
      m.classList.remove("show");
    };

    m.classList.add("show");
  }

  document.getElementById("startButton").onclick = () => {
    explorerName = document.getElementById("explorerName").value.trim();
    teamName = document.getElementById("teamName").value.trim();
    if (!explorerName) {
      alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    gameStarted = true;
    document.getElementById("introBackdrop").classList.remove("show");
    updateUI();
    startTimer();
    saveState();
    ensureMapInit();
  };

  // âœ… ë¶€íŒ…: ê²Œì´íŠ¸ â†’ ê¸°ì¡´ ë³µêµ¬/ë§µ ì´ˆê¸°í™”
  window.addEventListener("DOMContentLoaded", () => {
    setupGate();         // ë¨¼ì € ì ê¸ˆ/íƒ€ì´ë¨¸ ëª¨ë‹¬ ì ìš©
    restoreIfExists();   // ê¸°ì¡´ ì§„í–‰ ìƒíƒœ ë³µì›
    if (typeof google === "undefined" || !google.maps) {
      // ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ì•„ì§ ì•ˆ ë¡œë“œëœ ê²½ìš°
    } else {
      ensureMapInit();
    }
  });
</script>

<!-- Google Maps JS -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA7nXxqSqbwpKHN866MBWLAWm1GgTK2hyQ&callback=onMapsReady" async defer></script>
<!-- QR ì½”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</body>
</html>
