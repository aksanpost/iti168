<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>검붉은 달의 섬, 자월도 보물 탐험</title>
  <!-- iPhone 13 Pro 기준 프레임 고정 & 확대 방지 -->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --poster-orange: #faa000; /* 포스터 키컬러 */
      --poster-black: #050610;
      --text-main: #fef5d0;
    }

    /* 전체 화면 고정 + 스크롤/줌 최소화 */
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;  /* 페이지 자체는 스크롤 안 함 */
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo",
        system-ui, sans-serif;
      background: var(--poster-orange);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* iPhone 13 Pro 기준 프레임 느낌으로 고정 */
    #app {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 390px;   /* iPhone 13 Pro 너비 */
      height: 100vh;
      max-height: 844px;  /* iPhone 13 Pro 높이 */
      border-radius: 24px;
      border: 10px solid var(--poster-orange);
      background: var(--poster-black);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
      overflow: hidden;
    }

    @media (min-width: 430px) {
      #app {
        height: 844px;
      }
    }

    header {
      padding: 16px 18px 14px;
      background: radial-gradient(circle at top, #27120c 0, #050305 60%);
      border-bottom: 2px solid var(--poster-orange);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    .title {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .timer {
      font-variant-numeric: tabular-nums;
      padding: 6px 12px;
      border-radius: 999px;
      border: 2px solid var(--poster-orange);
      font-size: 14px;
      background: rgba(0,0,0,0.7);
    }

    .sub-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      opacity: 0.95;
    }

    .explorer-info {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .progress {
      font-size: 13px;
    }

    #map {
      flex: 1;
      width: 100%;
      border-top: 3px dashed var(--poster-orange);
      touch-action: pan-x pan-y;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.70);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: radial-gradient(circle at top, #29140c 0, #030308 55%);
      border-radius: 18px;
      padding: 18px 16px 14px;
      max-width: 380px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 3px solid var(--poster-orange);
      box-shadow: 0 18px 40px rgba(0,0,0,0.75);
      color: var(--text-main);
    }

    .modal h2 {
      font-size: 18px;
      margin-bottom: 10px;
      letter-spacing: 0.02em;
    }

    .modal p {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 10px;
      white-space: pre-line;
    }

    .modal-label {
      font-size: 13px;
      margin: 8px 0 4px;
    }

    .modal input[type="text"] {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.35);
      background: rgba(0,0,0,0.85);
      color: var(--text-main);
      font-size: 14px;
    }

    .modal input[type="text"]::placeholder {
      color: rgba(255,255,255,0.45);
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .btn {
      border: 2px solid var(--poster-orange);
      cursor: pointer;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .btn-primary {
      background: var(--poster-orange);
      color: var(--poster-black);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-main);
    }

    .btn-danger {
      background: #8b0013;
      color: #fff;
      border-color: #ff5060;
    }

    .small {
      font-size: 12px;
      opacity: 0.85;
    }

    #quizWrapper .small {
      margin-top: 4px;
    }

    #qrReader {
      width: 100%;
      min-height: 260px;
      background: #000;
      border-radius: 14px;
      overflow: hidden;
      margin: 8px 0 4px;
      border: 2px dashed var(--poster-orange);
    }

    #qrStatus {
      min-height: 18px;
      margin-top: 4px;
    }

    @media (max-width: 400px) {
      header {
        padding: 14px 14px 12px;
      }
      .title {
        font-size: 17px;
      }
      .timer {
        font-size: 13px;
        padding: 5px 10px;
      }
      .sub-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .modal {
        max-width: 360px;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="top-row">
      <div class="title">인천 보물섬 168 · 자월도</div>
      <div class="timer" id="timer">남은 시간 03:00:00</div>
    </div>
    <div class="sub-row">
      <div class="explorer-info" id="explorerInfo">탐험가: - / 팀: -</div>
      <div class="progress" id="progressInfo">수집한 보물: 0 / 9</div>
    </div>
  </header>
  <div id="map"></div>
</div>

<!-- 인트로 모달 -->
<div class="modal-backdrop show" id="introBackdrop">
  <div class="modal">
    <h2>검붉은 달의 섬, 자월도</h2>
    <p>
자월도 섬 수호자가 숨겨놓은 자월도의 보물들을 찾아보세요.

11월 15일 그믐날 오후 2시부터 단 3시간만
보물이 숨겨진 위치가 지도 위에 나타날 거예요.

당신에게 주어진 시간은 단 3시간.
지도 위에 표시된 보물 위치로 가서 QR보물을 수집하세요.
어떤 QR보물은 특정한 문제를 해결해야지만 수집할 수 있습니다.

모든 보물을 다 수집해서 돌아오면
해변 위로 신비한 검붉은 달이 뜰 겁니다.
달이 없는 그믐날에 붉은 달이라니…. 정말 신기하죠?

그럼 행운을 빌게요.</p>

    <label class="modal-label" for="explorerName">보물 탐험가 이름</label>
    <input id="explorerName" type="text" placeholder="이름을 입력하세요" />

    <label class="modal-label" for="teamName">보물을 탐험하는 팀명 (선택)</label>
    <input id="teamName" type="text" placeholder="팀명이 있으면 입력하세요" />

    <div class="modal-buttons">
      <button class="btn btn-primary" id="startButton">보물찾기 시작</button>
    </div>
  </div>
</div>

<!-- 일반/퀴즈 모달 -->
<div class="modal-backdrop" id="genericBackdrop">
  <div class="modal" id="genericModal">
    <h2 id="genericTitle"></h2>
    <p id="genericBody"></p>

    <div id="quizWrapper" style="display:none;">
      <p id="quizQuestion" style="margin-top:4px;"></p>
      <div class="small" id="quizHint"></div>
      <label class="modal-label" for="quizInput">정답을 입력하세요</label>
      <input id="quizInput" type="text" />
      <div class="small" id="quizAttempts"></div>
    </div>

    <div class="modal-buttons" id="genericButtons"></div>
  </div>
</div>

<!-- QR 스캐너 모달 -->
<div class="modal-backdrop" id="qrBackdrop">
  <div class="modal">
    <h2>보물 QR 스캔</h2>
    <p class="small">카메라 사용을 허용하고, 자월도 보물 QR코드를 화면 안에 맞춰주세요.</p>
    <div id="qrReader"></div>
    <div class="small" id="qrStatus"></div>
    <div class="modal-buttons">
      <button class="btn btn-secondary" id="qrCancelBtn">취소</button>
    </div>
  </div>
</div>

<script>
  // ====== 기본 상태 & 로컬 스토리지 키 ======
  const STORAGE_KEY = "jawol_treasure_state_v2";

  let map;
  let userMarker;
  let watchId = null;

  const TOTAL_TREASURES = 9;
  let collectedCount = 0;
  let explorerName = "";
  let teamName = "";

  let timerInterval = null;
  let endTime = null;
  let gameStartTime = null; // ms
  let gameStarted = false;

  const attemptsById = {};
  const lockedById = {};
  const clearedById = {};
  const markerById = {};

  let routePolyline = null;

  // TODO: GPX에서 뽑은 전체 트레킹 루트 좌표 넣기
  const TRAIL_ROUTE = [
    // { lat: 37.515000, lng: 126.287000 },
    // ...
  ];

  const JAWOL_CENTER = { lat: 37.515, lng: 126.287 };

  const TREASURES = [
    {
      id: 1,
      order: 1,
      name: "스타팅포인트 - 장골해수욕장 입구",
      position: { lat: 37.2502283, lng: 126.3120516 },
      qrCodeValue: "JAWOL_TREASURE_1",
      type: "quiz",
      quiz: {
        key: "q1",
        question: "자월도는 인천시 00군에 속해 있다.",
        answerMode: "includes",
        answerValue: ["옹진"],
        maxAttempts: 5,
        successMessage:
"훌륭하군요.\n\n다음 보물은 자월면사무소에 있습니다.\n면사무소에서 다음과 같은 패턴을 찾아 비밀번호를 입력하면 보물을 얻을 수 있어요.",
        failLockMessage:
"정답 기회를 5회 모두 사용했습니다.\n이 보물상자는 더 이상 열리지 않습니다."
      }
    },
    {
      id: 2,
      order: 2,
      name: "자월면사무소 앞 잔디밭",
      position: { lat: 37.1514, lng: 126.1826 },
      qrCodeValue: "JAWOL_TREASURE_2",
      type: "quiz",
      quiz: {
        key: "q2",
        question: "당신이 서 있는 곳의 위도와 경도를 순서대로 숫자만 입력하시오.",
        answerMode: "exact",
        answerValue: "3715141261826",
        maxAttempts: 5,
        successMessage:
"훌륭하군요.\n모든 보물들이 전부 위도와 경도로 표시가 돼 있으면 보물을 찾는 것도 쉬운데…\n옛날 사람들은 위도와 경도, GPS 같은 게 없었을 텐데 어떻게 보물을 숨기고 그 위치를 기억했을까요…\n\n아, 제일 높은 곳을 올라서 지형을 보면서 숨겼겠군요.\n자월도에서 제일 높은 곳으로 올라가 봅시다.\n지도를 따라 국사봉으로 가보세요.",
        failLockMessage:
"정답 기회를 5회 모두 사용했습니다.\n이 보물상자는 더 이상 열리지 않습니다."
      }
    },
    {
      id: 3,
      order: 3,
      name: "국사봉 정자 안",
      position: { lat: 37.2564139, lng: 126.3156307 },
      qrCodeValue: "JAWOL_TREASURE_3",
      type: "quiz",
      quiz: {
        key: "q3",
        question:
"[나라를 생각하고 한탄했던 곳, 국사봉]\n자월도는 조선시대 때 억울하게 죄를 뒤집어쓰고 유배 오는 유배지였어요.\n제일 높은 곳을 올라 나라를 생각하던 곳이라 국사봉이라는 이름이 붙여졌어요.\n\n그렇다면 당신이 지금 서 있는 국사봉의 해발고도 미터는?(숫자만 입력하시오)",
        answerMode: "exact",
        answerValue: "166",
        maxAttempts: 5,
        successMessage:
"자월도에서 제일 높은 곳을 잘 찾으셨군요.\n억울한 누명을 쓰고 유배 왔던 사람들을 생각해보니 자월도가 다시 보이네요.\n다음 보물은 돌 제단에 있습니다.\n조선시대에는 봉화대로도 사용됐다고 하더군요.",
        failLockMessage:
"정답 기회를 5회 모두 사용했습니다.\n이 보물상자는 더 이상 열리지 않습니다."
      }
    },
    {
      id: 4,
      order: 4,
      name: "돌 제단과 봉화대",
      position: { lat: 37.2560615, lng: 126.3173723 },
      qrCodeValue: "JAWOL_TREASURE_4",
      type: "quiz",
      quiz: {
        key: "q4",
        question:
"[돌 제단과 봉화대]\n조선시대에는 근처 가장 높은 곳에서 봉화를 올려 급한 소식들을 전달하곤 했죠.\n이 문제는 다음 QR보물이 숨겨져 있는 곳에 대한 힌트가 될 수 있습니다.\n\n겨울 시기에는 이 섬에도 서쪽에서 건조하고 강한 바람이 불어오죠.\n순우리말로 서쪽에서 부는 바람을 00바람이라고 합니다.\n00에 들어갈 말은?",
        answerMode: "includes",
        answerValue: ["하늬"],
        maxAttempts: 5,
        successMessage:
"정답입니다.\n다음 보물의 위치는 하늬께 해수욕장입니다.",
        failLockMessage:
"정답 기회를 5회 모두 사용했습니다.\n이 보물상자는 더 이상 열리지 않습니다."
      }
    },
    {
      id: 5,
      order: 5,
      name: "하늬께 해수욕장",
      position: { lat: 37.2565233, lng: 126.3264214 },
      qrCodeValue: "JAWOL_TREASURE_5",
      type: "story",
      story:
"이번에는 보물을 얻기 위한 퀴즈가 없습니다.\n여유롭게 풍경을 감상하며 목섬까지 이동해 보세요.\n목섬 구름다리를 건너면 안목섬에 있는 벤치를 잘 살펴보세요."
    },
    {
      id: 6,
      order: 6,
      name: "안목섬",
      position: { lat: 37.2604325, lng: 126.3285574 },
      qrCodeValue: "JAWOL_TREASURE_6",
      type: "story",
      story:
"이번에도 보물을 얻기 위한 퀴즈가 없습니다.\n여유롭게 풍경을 감상하며 비밀의 해변가로 가는 길을 찾아보세요.\n대나무가 우거진 숲을 지나야 비밀의 해변에 다다를 수 있답니다."
    },
    {
      id: 7,
      order: 7,
      name: "비밀의 해변",
      position: { lat: 37.2468665, lng: 126.3280569 },
      qrCodeValue: "JAWOL_TREASURE_7",
      type: "story",
      story:
"와, 이 해변. 정말 보물같이 아름답지 않나요?\n고생한 보람이 있네요.\n이번에도 보물을 얻기 위한 퀴즈가 없습니다.\n다시 대나무숲을 지나 자월도섬마을박물관으로 이동하세요.\n가는 길 해변도 함께 감상하시구요."
    },
    {
      id: 8,
      order: 8,
      name: "자월도섬마을박물관",
      position: { lat: 37.2448629, lng: 126.3182970 },
      qrCodeValue: "JAWOL_TREASURE_8",
      type: "quiz",
      quiz: {
        key: "q8",
        question:
"[자월도의 지난 역사들을 한눈에]\n해변을 걷다 보니 자월도의 바닷물이 시시각각 변하네요.\n자월도를 비롯한 서해 섬은 조수간만의 차이가 큽니다.\n큰 조수간만 차이를 이용해서 물고기를 잡는 방법이 섬마을박물관에 소개돼 있습니다.\n\n어망이 발달하기 이전, 갯벌에 돌을 쌓아 썰물에 물고기가 빠져나가지 못하게 가두어 잡는 전통적인 어업 방식을 뭐라고 하나요?\n2개 다 기입하세요.",
        answerMode: "multiIncludes",
        answerValue: ["돌살","독살"],
        maxAttempts: 5,
        successMessage:
"오늘 저녁에 갯벌에서 전통적인 방식으로 물고기를 잡아볼 수 있겠다는 생각도 듭니다.\n조수간만이 커서 어부들이 썰물 때는 배를 해안으로 대기도 힘들었을 것 같아요.\n\n안 그래도 아내를 두고 바다를 나갔다가 돌아오지 못한 어부가 있다는데\n그 어부를 찾으면 마지막 QR보물을 찾을 수 있을 거예요.",
        failLockMessage:
"정답 기회를 5회 모두 사용했습니다.\n이 보물상자는 더 이상 열리지 않습니다."
      }
    },
    {
      id: 9,
      order: 9,
      name: "어부상",
      position: { lat: 37.2447685, lng: 126.3170192 },
      qrCodeValue: "JAWOL_TREASURE_9",
      type: "quiz",
      quiz: {
        key: "q9",
        question:
"[돌아오지 않던 어부를 기다리다]\n자월도에는 열녀바위와 어부상도 함께 있죠.\n어부가 바다로 나갔다가 돌아오지 않아 부인이 하염 없이 기다리다 바위가 되었다는 이야기가 있습니다.\n\n마지막 보물을 획득하기 위한 퀴즈입니다.\n자월도의 특산물 중 바다에서 나는 특산물 2개가 무엇인가요?\n(힌트 : 자월도 선착장에 써 있는 자월도 소개 표지를 확인해보세요.)",
        answerMode: "multiIncludes",
        answerValue: ["굴","바지락"],
        maxAttempts: 5,
        successMessage:
"자월도에 흩어져 있는 QR보물을 모두 수집하셨군요.\n자 그럼 이제 서둘러서 우리가 출발했던 그 곳으로 돌아가 보시죠.\n자월도의 진짜 보물, 검붉은 달이 뜨는 걸 서둘러 보러 가시죠.",
        failLockMessage:
"정답 기회를 5회 모두 사용했습니다.\n이 보물상자는 더 이상 열리지 않습니다."
      }
    }
  ];

  const introBackdrop = document.getElementById("introBackdrop");
  const startButton = document.getElementById("startButton");
  const explorerNameInput = document.getElementById("explorerName");
  const teamNameInput = document.getElementById("teamName");

  const genericBackdrop = document.getElementById("genericBackdrop");
  const genericTitle = document.getElementById("genericTitle");
  const genericBody = document.getElementById("genericBody");
  const genericButtons = document.getElementById("genericButtons");
  const quizWrapper = document.getElementById("quizWrapper");
  const quizQuestionEl = document.getElementById("quizQuestion");
  const quizHintEl = document.getElementById("quizHint");
  const quizInput = document.getElementById("quizInput");
  const quizAttemptsEl = document.getElementById("quizAttempts");

  const qrBackdrop = document.getElementById("qrBackdrop");
  const qrStatus = document.getElementById("qrStatus");
  const qrCancelBtn = document.getElementById("qrCancelBtn");

  let currentQuizTreasure = null;

  // ====== 로컬 스토리지 저장/복원 ======
  function saveState() {
    if (!window.localStorage) return;
    const state = {
      explorerName,
      teamName,
      startTime: gameStartTime,
      collectedCount,
      attemptsById,
      lockedById,
      clearedById
    };
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.warn("state 저장 실패", e);
    }
  }

  function loadState() {
    if (!window.localStorage) return null;
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (e) {
      console.warn("state 로드 실패", e);
      return null;
    }
  }

  function clearState() {
    if (!window.localStorage) return;
    try {
      localStorage.removeItem(STORAGE_KEY);
    } catch (e) {
      console.warn("state 삭제 실패", e);
    }
  }

  // ====== 모달 & 퀴즈 ======
  function openModal({ title, body, buttons = [] }) {
    genericTitle.textContent = title || "";
    genericBody.textContent = body || "";
    quizWrapper.style.display = "none";
    quizInput.value = "";
    quizHintEl.textContent = "";
    quizAttemptsEl.textContent = "";
    currentQuizTreasure = null;

    genericButtons.innerHTML = "";
    buttons.forEach(btn => {
      const el = document.createElement("button");
      el.textContent = btn.label;
      el.className = "btn " + (btn.variant === "secondary"
        ? "btn-secondary"
        : btn.variant === "danger"
          ? "btn-danger"
          : "btn-primary");
      el.addEventListener("click", btn.onClick);
      genericButtons.appendChild(el);
    });

    genericBackdrop.classList.add("show");
  }

  function closeModal() {
    genericBackdrop.classList.remove("show");
  }

  function openQuizModal(treasure) {
    currentQuizTreasure = treasure;
    const q = treasure.quiz;

    genericTitle.textContent = treasure.name;
    genericBody.textContent = "";
    quizWrapper.style.display = "block";
    quizQuestionEl.textContent = q.question;
    quizInput.value = "";
    quizInput.focus();

    const attempts = attemptsById[treasure.id] || 0;
    const remain = q.maxAttempts - attempts;
    quizAttemptsEl.textContent =
      `남은 시도 횟수: ${remain} / ${q.maxAttempts}`;
    quizHintEl.textContent = "";

    genericButtons.innerHTML = "";

    const submitBtn = document.createElement("button");
    submitBtn.textContent = "정답 제출";
    submitBtn.className = "btn btn-primary";
    submitBtn.addEventListener("click", () => {
      handleQuizSubmit(treasure);
    });

    const cancelBtn = document.createElement("button");
    cancelBtn.textContent = "취소";
    cancelBtn.className = "btn btn-secondary";
    cancelBtn.addEventListener("click", closeModal);

    genericButtons.appendChild(cancelBtn);
    genericButtons.appendChild(submitBtn);

    genericBackdrop.classList.add("show");
  }

  function normalizeStr(s) {
    return (s || "").toString().trim();
  }

  function handleQuizSubmit(treasure) {
    const q = treasure.quiz;
    const inputRaw = quizInput.value;
    const input = normalizeStr(inputRaw);

    if (!input) {
      quizHintEl.textContent = "정답을 입력해 주세요.";
      return;
    }

    const attempts = attemptsById[treasure.id] || 0;
    if (attempts >= q.maxAttempts) {
      quizHintEl.textContent = "더 이상 시도할 수 없습니다.";
      return;
    }

    const isCorrect = checkAnswer(q, input);

    if (isCorrect) {
      lockedById[treasure.id] = false;
      if (!clearedById[treasure.id]) {
        clearedById[treasure.id] = true;
        collectedCount++;
      }
      updateProgressUI();
      updateRouteByProgress();
      saveState();

      genericBackdrop.classList.remove("show");

      openModal({
        title: treasure.name,
        body: q.successMessage,
        buttons: [
          {
            label: "확인",
            variant: "primary",
            onClick: () => {
              closeModal();
              checkAllCleared();
            }
          }
        ]
      });
    } else {
      attemptsById[treasure.id] = attempts + 1;
      const remain = q.maxAttempts - attemptsById[treasure.id];
      if (remain <= 0) {
        lockedById[treasure.id] = true;
        quizAttemptsEl.textContent =
          `남은 시도 횟수: 0 / ${q.maxAttempts}`;
        quizHintEl.textContent = q.failLockMessage;
        const marker = markerById[treasure.id];
        if (marker) marker.setOpacity(0.4);
      } else {
        quizAttemptsEl.textContent =
          `남은 시도 횟수: ${remain} / ${q.maxAttempts}`;
        quizHintEl.textContent = "정답이 아닙니다. 다시 시도해 보세요.";
      }
      saveState();
    }
  }

  function checkAnswer(q, input) {
    const mode = q.answerMode;
    if (mode === "exact") {
      return normalizeStr(input) === normalizeStr(q.answerValue);
    }
    if (mode === "includes") {
      const valArr = Array.isArray(q.answerValue)
        ? q.answerValue
        : [q.answerValue];
      const loweredInput = input.toLowerCase();
      return valArr.some(v => loweredInput.includes(v.toLowerCase()));
    }
    if (mode === "multiIncludes") {
      const loweredInput = input.toLowerCase();
      return q.answerValue.every(v =>
        loweredInput.includes(v.toLowerCase())
      );
    }
    return false;
  }

  // ====== 지도 & GPS ======
  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: JAWOL_CENTER,
      zoom: 14,
      styles: [
        { elementType: "geometry", stylers: [{ color: "#050712" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#050712" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#fef5d0" }] },
        { featureType: "poi", stylers: [{ visibility: "off" }] },
        { featureType: "road", stylers: [{ color: "#1b1712" }] },
        { featureType: "water", stylers: [{ color: "#0b1020" }] }
      ]
    });

    TREASURES.forEach(t => {
      const marker = new google.maps.Marker({
        position: t.position,
        map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: "#faa000",
          fillOpacity: 1,
          strokeColor: "#050610",
          strokeWeight: 2
        },
        label: {
          text: t.order.toString(),
          color: "#050610",
          fontSize: "12px",
          fontWeight: "bold"
        },
        title: t.name
      });

      markerById[t.id] = marker;
      marker.addListener("click", () => {
        onTreasureMarkerClick(t);
      });
    });

    // 잠긴 보물/클리어 상태에 맞게 마커 스타일 적용
    applyMarkerStylesFromState();

    if (TRAIL_ROUTE && TRAIL_ROUTE.length > 0) {
      routePolyline = new google.maps.Polyline({
        path: [],
        geodesic: true,
        strokeColor: "#faa000",
        strokeOpacity: 0.95,
        strokeWeight: 3.5,
        map: map
      });
      updateRouteByProgress();
    }

    if (navigator.geolocation) {
      watchId = navigator.geolocation.watchPosition(
        position => {
          const { latitude, longitude } = position.coords;
          const pos = { lat: latitude, lng: longitude };

          if (!userMarker) {
            userMarker = new google.maps.Marker({
              position: pos,
              map,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 6,
                fillColor: "#fef5d0",
                fillOpacity: 1,
                strokeColor: "#050610",
                strokeWeight: 2
              },
              title: "현재 위치"
            });
            map.setCenter(pos);
          } else {
            userMarker.setPosition(pos);
          }
        },
        error => {
          console.error("GPS 에러", error);
          openModal({
            title: "GPS 오류",
            body: "현재 위치를 가져올 수 없습니다. 브라우저 위치 권한을 확인해 주세요.",
            buttons: [
              {
                label: "닫기",
                variant: "primary",
                onClick: closeModal
              }
            ]
          });
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
      );
    } else {
      openModal({
        title: "GPS 미지원",
        body: "이 기기에서는 GPS를 사용할 수 없습니다.",
        buttons: [
          {
            label: "닫기",
            variant: "primary",
            onClick: closeModal
          }
        ]
      });
    }
  }

  function applyMarkerStylesFromState() {
    TREASURES.forEach(t => {
      const marker = markerById[t.id];
      if (!marker) return;
      if (lockedById[t.id]) {
        marker.setOpacity(0.4);
      } else {
        marker.setOpacity(1);
      }
    });
  }

  function onTreasureMarkerClick(treasure) {
    if (!userMarker) {
      openModal({
        title: treasure.name,
        body: "현재 위치를 불러오는 중입니다. 잠시 후 다시 시도해 주세요.",
        buttons: [
          {
            label: "확인",
            variant: "primary",
            onClick: closeModal
          }
        ]
      });
      return;
    }

    if (lockedById[treasure.id]) {
      openModal({
        title: treasure.name,
        body: "이 보물상자는 더 이상 열리지 않습니다.",
        buttons: [
          {
            label: "확인",
            variant: "primary",
            onClick: closeModal
          }
        ]
      });
      return;
    }

    const userPos = userMarker.getPosition();
    const dist = distanceInMeters(
      userPos.lat(),
      userPos.lng(),
      treasure.position.lat,
      treasure.position.lng
    );

    if (dist > 5) {
      openModal({
        title: treasure.name,
        body:
          `보물상자까지 아직 멀리 있네요.\n\n` +
          `현재 거리: 약 ${Math.round(dist)} m\n5m 이내로 더 가까이 다가가면 보물상자를 열 수 있습니다.`,
        buttons: [
          {
            label: "확인",
            variant: "primary",
            onClick: closeModal
          }
        ]
      });
      return;
    }

    openModal({
      title: treasure.name,
      body: "QR 보물을 찾으셨나요?\n찾으셨으면 카메라를 열어 찍어주세요.",
      buttons: [
        {
          label: "취소",
          variant: "secondary",
          onClick: closeModal
        },
        {
          label: "보물 QR 찍기",
          variant: "primary",
          onClick: () => {
            closeModal();
            openQRScanner(treasure);
          }
        }
      ]
    });
  }

  // ====== QR 스캐너 ======
  let html5QrCode = null;
  let qrScanning = false;

  function openQRScanner(treasure) {
    qrStatus.textContent = "";
    qrBackdrop.classList.add("show");

    if (!window.Html5Qrcode) {
      qrStatus.textContent = "QR 라이브러리를 불러오지 못했습니다.";
      return;
    }

    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("qrReader");
    }

    qrScanning = true;

    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      decodedText => {
        if (!qrScanning) return;

        if (decodedText === treasure.qrCodeValue) {
          qrStatus.textContent = "보물 QR을 인식했습니다!";
          qrScanning = false;

          html5QrCode.stop().then(() => {
            html5QrCode.clear();
            qrBackdrop.classList.remove("show");
            handleQRVerified(treasure);
          }).catch(() => {
            qrBackdrop.classList.remove("show");
            handleQRVerified(treasure);
          });
        } else {
          qrStatus.textContent =
            "다른 QR코드 같습니다. 자월도 보물 QR을 다시 스캔해 주세요.";
        }
      },
      errorMessage => {
        // 반복 에러 무시
      }
    ).catch(err => {
      console.error(err);
      qrStatus.textContent =
        "카메라를 시작할 수 없습니다. HTTPS 환경과 브라우저 권한을 확인해 주세요.";
    });
  }

  function stopQRScanner() {
    if (html5QrCode && qrScanning) {
      qrScanning = false;
      html5QrCode.stop().then(() => html5QrCode.clear()).catch(()=>{});
    }
    qrBackdrop.classList.remove("show");
  }

  qrCancelBtn.addEventListener("click", () => {
    stopQRScanner();
  });

  function handleQRVerified(treasure) {
    if (treasure.type === "quiz") {
      openQuizModal(treasure);
      return;
    }

    if (!clearedById[treasure.id]) {
      clearedById[treasure.id] = true;
      collectedCount++;
      updateProgressUI();
      updateRouteByProgress();
      saveState();
    }

    openModal({
      title: treasure.name,
      body: treasure.story,
      buttons: [
        {
          label: "확인",
          variant: "primary",
          onClick: () => {
            closeModal();
            checkAllCleared();
          }
        }
      ]
    });
  }

  // ====== 거리 & 타이머 & UI ======
  function distanceInMeters(lat1, lon1, lat2, lon2) {
    function toRad(v) { return v * Math.PI / 180; }
    const R = 6371000;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) *
      Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  const timerEl = document.getElementById("timer");
  const progressInfo = document.getElementById("progressInfo");
  const explorerInfo = document.getElementById("explorerInfo");

  function startTimer(existingStartTime) {
    const THREE_HOURS = 3 * 60 * 60 * 1000;

    if (existingStartTime) {
      gameStartTime = existingStartTime;
    } else {
      gameStartTime = Date.now();
    }

    endTime = gameStartTime + THREE_HOURS;

    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      const now = Date.now();
      const diff = endTime - now;

      if (diff <= 0) {
        clearInterval(timerInterval);
        timerEl.textContent = "남은 시간 00:00:00";
        clearState(); // 라운드 끝나면 저장 상태 삭제
        openModal({
          title: "시간 종료",
          body: "3시간이 모두 지났습니다.\n출발지로 돌아가 주세요.",
          buttons: [
            {
              label: "확인",
              variant: "primary",
              onClick: closeModal
            }
          ]
        });
        return;
      }

      const totalSeconds = Math.floor(diff / 1000);
      const h = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
      const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
      const s = String(totalSeconds % 60).padStart(2, "0");
      timerEl.textContent = `남은 시간 ${h}:${m}:${s}`;
    }, 1000);
  }

  function updateProgressUI() {
    progressInfo.textContent =
      `수집한 보물: ${collectedCount} / ${TOTAL_TREASURES}`;
  }

  function updateExplorerInfo() {
    explorerInfo.textContent =
      `탐험가: ${explorerName || "-"} / 팀: ${teamName || "-"}`
  }

  function updateRouteByProgress() {
    if (!routePolyline || !TRAIL_ROUTE || TRAIL_ROUTE.length === 0) return;

    const maxSegments = TOTAL_TREASURES - 1;
    const clearedForRoute = Math.max(0, Math.min(collectedCount, maxSegments));

    const ratio = (maxSegments === 0)
      ? 1
      : clearedForRoute / maxSegments;

    const cutIndex = Math.floor(TRAIL_ROUTE.length * ratio);
    const visiblePath = TRAIL_ROUTE.slice(0, cutIndex);

    routePolyline.setPath(visiblePath);
  }

  function checkAllCleared() {
    if (collectedCount >= TOTAL_TREASURES) {
      openModal({
        title: "검붉은 달이 떠오릅니다",
        body:
"자월도 곳곳에 흩어져 있던 모든 QR보물을 수집했습니다.\n\n해변 위로 신비한 검붉은 달이 떠오릅니다.\n이제 우리가 처음 출발했던 장골해수욕장으로 돌아가\n당신의 여정을 마무리해 주세요.",
        buttons: [
          {
            label: "확인",
            variant: "primary",
            onClick: closeModal
          }
        ]
      });
    }
  }

  // ====== 초기 로드 시 저장된 상태 복원 ======
  function restoreIfExists() {
    const saved = loadState();
    if (!saved || !saved.explorerName || !saved.startTime) return;

    const THREE_HOURS = 3 * 60 * 60 * 1000;
    const now = Date.now();

    // 3시간이 이미 지났으면 상태 삭제
    if (now >= saved.startTime + THREE_HOURS) {
      clearState();
      return;
    }

    explorerName = saved.explorerName;
    teamName = saved.teamName || "";
    gameStartTime = saved.startTime;
    gameStarted = true;

    if (typeof saved.collectedCount === "number") {
      collectedCount = saved.collectedCount;
    }

    if (saved.attemptsById) {
      Object.assign(attemptsById, saved.attemptsById);
    }
    if (saved.lockedById) {
      Object.assign(lockedById, saved.lockedById);
    }
    if (saved.clearedById) {
      Object.assign(clearedById, saved.clearedById);
    }

    introBackdrop.classList.remove("show");
    updateExplorerInfo();
    updateProgressUI();

    initMap();               // 지도/마커/루트 초기화 + 상태 반영
    startTimer(saved.startTime); // 남은 시간 이어서
  }

  // ====== 이벤트 바인딩 ======
  startButton.addEventListener("click", () => {
    if (gameStarted) return; // 이미 진행 중이면 중복 시작 방지

    explorerName = explorerNameInput.value.trim();
    teamName = teamNameInput.value.trim();

    if (!explorerName) {
      alert("보물 탐험가 이름을 입력해 주세요.");
      return;
    }

    gameStarted = true;
    introBackdrop.classList.remove("show");
    updateExplorerInfo();
    updateProgressUI();
    startTimer();     // 새 라운드 시작 → 현재 시간 기준
    initMap();
    saveState();      // 이름/팀명/시작시간 저장
  });

  // 페이지 로드 시 즉시 복원 시도
  restoreIfExists();
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA7nXxqSqbwpKHN866MBWLAWm1GgTK2hyQ">
</script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

</body>
</html>
